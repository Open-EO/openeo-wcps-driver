for $stcov in ( S2_L2A_T32TPS_20M ) return encode
(
	condense min
		over $pm t (imageCrsDomain($stcov[DATE ("2017-01-01":"2017-01-31")],DATE ))
		using (((int)$stcov.B8A[DATE($pm), E(652000:672000), N(5161000:5181000)] - 
				     $stcov.B04[DATE($pm), E(652000:672000), N(5161000:5181000)]) /
			   ((int)$stcov.B8A[DATE($pm), E(652000:672000), N(5161000:5181000)] + 
			         $stcov.B04[DATE($pm), E(652000:672000), N(5161000:5181000)])
)
, "png")



for $c1 in ( S2_L2A_T32TPS_20M ) return encode 
( 
	(
		(double)
		$c1.B8A[E(652000:672000),N(5161000:5181000),DATE("2017-01-01":"2017-01-31")] - 
		$c1.B04[E(652000:672000),N(5161000:5181000),DATE("2017-01-01":"2017-01-31")]
	) / 
	(
		(double)
		$c1.B8A[E(652000:672000),N(5161000:5181000),DATE("2017-01-01":"2017-01-31")] + 
		$c1.B04[E(652000:672000),N(5161000:5181000),DATE("2017-01-01":"2017-01-31")]
	)
    , "JSON"
)